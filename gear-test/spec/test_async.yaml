title: Async-await

codes:
  # Save child's code
  - path: examples/async/child_project.opt.wasm

programs:
  - id: 1
    path: target/wasm32-unknown-unknown/release/demo_async.opt.wasm
    init_message:
      kind: utf-8
      value: "{2},{3},{4}"

  - id: 2
    path: target/wasm32-unknown-unknown/release/demo_ping.opt.wasm

  - id: 3
    path: target/wasm32-unknown-unknown/release/demo_ping.opt.wasm

  - id: 4
    path: target/wasm32-unknown-unknown/release/demo_ping.opt.wasm

  - id: 5
    path: target/wasm32-unknown-unknown/release/demo_mutex.opt.wasm
    init_message:
      kind: utf-8
      value: "{2}"

  - id: 6
    path: target/wasm32-unknown-unknown/release/demo_rwlock_write.opt.wasm
    init_message:
      kind: utf-8
      value: "{2}"

fixtures:
  - title: async-await

    messages:
      - destination: 1
        payload: &start
          kind: utf-8
          value: START

    expected:
      - step: 1
        messages:
          - destination: 2
            payload: &ping
              kind: utf-8
              value: PING

      - step: 2
        messages:
          - destination: 1
            payload: &pong
              kind: utf-8
              value: PONG

      - step: 3
        messages:
          - destination: 1
            payload: *start

      - step: 4
        messages:
          - destination: 3
            payload: *ping

      - step: 5
        messages:
          - destination: 1
            payload: *pong

      - step: 6
        messages:
          - destination: 1
            payload: *start

      - step: 7
        messages:
          - destination: 4
            payload: *ping

      - step: 8
        messages:
          - destination: 1
            payload: *pong

      - step: 9
        messages:
          - destination: 1
            payload: *start

      - step: 10
        log:
          - destination: 1000001
            payload: &success
              kind: utf-8
              value: SUCCESS

  - title: mutex

    messages:
      - destination: 5
        payload: *start
      - destination: 5
        payload: *start

    expected:
      - step: 1
        messages:
          - destination: 5
            payload: *start
          - destination: 2
            payload: *ping
      - step: 2
        messages:
          - destination: 2
            payload: *ping
      - step: 3
        messages:
          - destination: 5
            payload: *pong
      - step: 4
        messages:
          - destination: 5
            payload: *start
      - step: 5
        messages:
          - destination: 5
            payload: *start
      - step: 6
        messages:
          - destination: 2
            payload: *ping
      - step: 7
        messages:
          - destination: 5
            payload: *pong

  - title: rwlock-write # RwLock writer-only is similar to mutex

    messages:
      - destination: 6
        payload: *start
      - destination: 6
        payload: *start

    expected:
      - step: 1
        messages:
          - destination: 6
            payload: *start
          - destination: 2
            payload: *ping
      - step: 2
        messages:
          - destination: 2
            payload: *ping
      - step: 3
        messages:
          - destination: 6
            payload: *pong
      - step: 4
        messages:
          - destination: 6
            payload: *start
      - step: 5
        messages:
          - destination: 6
            payload: *start
      - step: 6
        messages:
          - destination: 2
            payload: *ping
      - step: 7
        messages:
          - destination: 6
            payload: *pong

  - title: Async creation of program by program

    messages:
        - destination: 1
          payload:
            kind: utf-8
            value: CREATE

    expected:
      - step: 1
        messages:
        - destination:
            kind: h256
            value: 0x56ff19a3cc926341e0c7dab8cdcbb23eac711940c8f04619043d0adbeb8264a1
          init: true
          payload:
            kind: utf-8
            value: unique
      - step: 2
        messages:
        - destination: 1
          payload:
            kind: utf-8
            value: init unique
      - step: 3
        messages:
        - destination: 1
          payload:
            kind: utf-8
            value: CREATE
      - step: 4
        messages:
          - destination:
              kind: h256
              value: 0x56ff19a3cc926341e0c7dab8cdcbb23eac711940c8f04619043d0adbeb8264a1
            payload:
              kind: utf-8
              value: unique
      - step: 5
        messages:
        - destination: 1
          payload:
            kind: utf-8
            value: handle unique
      - step: 6
        messages:
        - destination: 1
          payload:
            kind: utf-8
            value: CREATE
      - step: 7
        messages:
        - destination:
            kind: h256
            value: 0xe70df01c6d38f490513daa11b1af17318123582f7d07c3a1438ca48612497a7f
          payload:
            kind: utf-8
            value: not unique
      - step: 8
        messages:
        - destination: 1
          payload:
            kind: utf-8
            value: <init not unique
      - step: 9
        messages:
        - destination: 1
          payload:
            kind: utf-8
            value: CREATE
      - step: 10
        messages:
        - destination:
            kind: h256
            value: 0xe70df01c6d38f490513daa11b1af17318123582f7d07c3a1438ca48612497a7f
          payload:
            kind: utf-8
            value: not unique
      - step: 11
        messages:
        - destination: 1
          payload:
            kind: utf-8
            value: handle not unique


